name: Anchore Syft SBOM scan with Trivy License Check

on:
  push:
    branches: '**'

permissions:
  id-token: write
  contents: write

jobs:
  Anchore-Build-Scan:
    permissions: write-all

    runs-on: ubuntu-latest
    steps:
      - name: Checkout the code
        uses: actions/checkout@v4

      - name: Build the Docker image
        run: docker build . --file Dockerfile --tag localbuild/testimage:latest

      - name: Scan the image and upload dependency results
        id: sbom_scan
        uses: anchore/sbom-action@latest
        with:
          image: "localbuild/testimage:latest"
          artifact-name: image.spdx.json
          dependency-snapshot: true

      - name: List SBOM Output Directory
        run: |
          echo "Contents of the SBOM action output directory:"
          ls -al /tmp/sbom-action-* || true

      - name: Create artifacts directory
        run: mkdir -p artifacts

      - name: Move SBOM artifact
        run: |
          mv /tmp/sbom-action-*/image.spdx.json artifacts/image.spdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: artifacts/image.spdx.json

      # New Step: Run Trivy License Check
      - name: Run Trivy License Check
        uses: aquasecurity/trivy-action@v0.20.0  # Make sure you're using the version you're working with
        with:
          image-ref: "localbuild/testimage:latest"  # Correct input for specifying the image
          format: "json"  # Output format
          scan-type: "license"  # Perform a license check
          output: "trivy-license-report.json"  # Specify output file for the report

      - name: Display Trivy License Report
        run: |
          echo "Displaying Trivy License Check results..."
          cat trivy-license-report.json

      - name: Fail the build if GPL-3.0 license is found
        run: |
          if grep -q 'GPL-3.0' trivy-license-report.json; then
            echo "GPL-3.0 license found in dependencies, which may be incompatible!"
            exit 1
          fi

      - name: Upload Trivy License Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-license-report
          path: trivy-license-report.json
