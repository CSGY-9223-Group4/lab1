name: Secret Scan2

on:
  push:
    branches: '**'  # all branches

  pull_request:
    branches:
      - main

permissions:
  contents: read    # Allows reading repository contents
  statuses: write   # Allows writing commit statuses

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install TruffleHog
        run: pip install truffleHog

      - name: Run TruffleHog
        id: trufflehog
        run: |
          # Run TruffleHog and capture output and error
          output=$(trufflehog --regex --json . 2>&1) || true
          echo "$output" > secrets.json                  # Save full output to secrets.json for debugging
          echo "$output" | jq -r '.[] | .path' > found_secrets.txt || true  # Extract file paths of found secrets

      - name: Check for secrets
        id: check-secrets
        run: |
          if [ -s found_secrets.txt ]; then              # Check if found_secrets.txt is not empty
            echo "Secrets found in the repository!"
            echo "status=fail" >> $GITHUB_ENV             # Set status to fail in the environment
            cat found_secrets.txt                          # Print paths of found secrets
          else
            echo "No secrets found."
            echo "status=success" >> $GITHUB_ENV           # Set status to success in the environment
          fi

      - name: Set commit status
        run: |
          curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
          -d "{\"state\": \"${{ env.status }}\", \"context\": \"Secret Scan\"}"  # Set commit status based on found secrets
